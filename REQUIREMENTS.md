# 自動扣款機器人需求說明書

---

## 主題：訂閱週期與扣款邏輯

### 標題：訂閱扣款週期可自定義
- **描述：** 支援月、年、季、週等多種扣款週期，週期從訂閱開始日計算。須正確處理大小月、閏年。
- **備註：** 例：1/31 訂閱，2月扣款日為2/28（或2/29），下期為3/31。

---

## 主題：優惠與方案

### 標題：優惠方案設計
- **描述：** 支援優惠活動（如第一期免費、特定週期優惠、原價恢復等），可為優惠設定優先級。
- **備註：** 僅能套用一種優惠，優惠期結束後自動查找其他可用優惠，否則恢復原價。

### 標題：優惠碼機制
- **描述：** 優惠碼可指定優惠價格及優惠期數，僅能使用一次。適用於新訂閱者，無啟動條件。
- **備註：** 已使用過的優惠碼即失效，不能重複使用。

### 標題：檔期優惠
- **描述：** 可設定特定期間優惠（如周年慶、過年檔期），並與優惠碼比較優先級。
- **備註：** 優惠優先級由系統設計決定。

---

## 主題：方案轉換

### 標題：方案切換支援
- **描述：** 支援用戶將訂閱從月方案轉為年方案等，轉換後自下個週期生效，原方案未到期不返還剩餘金額。
- **備註：** 剩餘優惠期數將依新方案週期承接。

---

## 主題：退款管理

### 標題：退款條件與流程
- **描述：** 僅允許用戶主動取消時申請全額退款，退款時機可依產品設定與全域設定雙軌設計，產品設定優先。
- **備註：** 參考試用期退款設計。

---

## 主題：扣款失敗與重試

### 標題：扣款失敗重試與寬限期
- **描述：** 扣款失敗時需根據失敗原因分類，支援重試（如網路錯誤）、延後重試（如餘額不足）、不可重試（如卡片停用）。重試次數與寬限期依產品設定，無設定則以全域預設。
- **備註：** 寬限期內用戶若手動補款則無需再重試，扣款失敗可延長寬限期，延長次數及天數可自定義。建議建立一張對照表映射失敗原因與重試策略。

---

## 主題：狀態管理與資料紀錄

### 標題：訂閱狀態與生命週期
- **描述：** 參照 Google In-App Purchase 狀態，明確定義訂閱各階段（如：待生效、已生效、寬限期、已取消、退款中等），及狀態流轉規則。
- **備註：** 狀態流轉需與扣款、退款、方案異動等流程密切結合。

### 標題：扣款歷史與異常記錄
- **描述：** 必須詳實記錄每次扣款、異常、重試、人工介入等操作。
- **備註：** 目前產品已有相關記錄，但需補強以支援完整追蹤與申訴。

---

## 主題：系統擴充性與彈性

### 標題：策略模式與規則引擎
- **描述：** 扣款、優惠、重試、退款等規則需設計為可擴充（策略模式或規則引擎），支援日後新增或調整無痛上線。
- **備註：** 可針對不同產品/方案做差異化設定。

### 標題：多平台支付支援
- **描述：** 現階段可預留設計，支援未來多種支付方式（如信用卡、電子支付等）。
- **備註：** 未來可針對不同支付方式設計不同重試與優惠策略。

### 標題：人工介入與應急流程
- **描述：** 需設計人工介入流程以處理系統故障、第三方支付服務中斷等例外狀況。
- **備註：** 須能追蹤與記錄人工操作歷程。

---

## 主題：合規性與資料安全

### 標題：法規遵循
- **描述：** 資料處理應符合GDPR等個資法規，預留因應其他在地法規的彈性。
- **備註：** 資料加密、保存期限等細節，未來視法規或公司政策調整。

---

## 主題：API與資料結構

### 標題：API/資料結構規劃
- **描述：** 預先設計API介面及資料結構，方便前後端協作與日後擴充。
- **備註：** 各主題皆應有對應資料欄位與API端點，支援資料查詢、異常追蹤、狀態變更等。

---

## 主題：文件化策略

### 標題：文件與管理後台
- **描述：** 需有完善文件記錄產品邏輯、狀態流、規則配置、異常處理、API設計等，支援團隊協作與稽核。
- **備註：** 管理後台可查詢、導出扣款與異常紀錄。

---

## 主題：未來擴充與預留

### 標題：通知、Webhook與外部串接
- **描述：** 預留事件鉤子（如Webhook）、API設計，支援未來與行銷、客服、通知等外部服務串接。
- **備註：** 目前暫不實作，但需於架構上留有彈性。

---

（如需狀態流轉圖、異常對照表等補充，請續與產品/技術團隊討論確認）